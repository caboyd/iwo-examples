{"version":3,"file":"UniformBuffer.js","sources":["../../../../iwo/src/graphics/UniformBuffer.ts"],"sourcesContent":["import { Shader } from \"./shader/Shader\";\r\nimport { UniformBlock } from \"./Uniform\";\r\nimport TypedArray = NodeJS.TypedArray;\r\n\r\nconst BAD_VALUE = 4294967295;\r\n\r\nexport class UniformBuffer {\r\n    public id: WebGLBuffer;\r\n    public data: ArrayBuffer;\r\n    public view: Float32Array;\r\n    public map: Map<string, UniformBlock>;\r\n    public name: string;\r\n\r\n    public constructor(shader: Shader, uniform_block_name: string) {\r\n        const gl = shader.gl;\r\n        const program = shader.ID;\r\n\r\n        this.name = uniform_block_name;\r\n        this.id = gl.createBuffer()!;\r\n        this.map = new Map<string, UniformBlock>();\r\n\r\n        const block_index = gl.getUniformBlockIndex(program, this.name);\r\n\r\n        //UniformBuffer doesn't exist or was optimized out\r\n        if (block_index === BAD_VALUE) {\r\n            this.data = new ArrayBuffer(0);\r\n            this.view = new Float32Array(this.data);\r\n            return;\r\n        }\r\n\r\n        const block_size = gl.getActiveUniformBlockParameter(program, block_index, gl.UNIFORM_BLOCK_DATA_SIZE);\r\n        const indices = gl.getActiveUniformBlockParameter(\r\n            program,\r\n            block_index,\r\n            gl.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES\r\n        );\r\n        const uniform_offsets = gl.getActiveUniforms(program, indices, gl.UNIFORM_OFFSET);\r\n\r\n        this.data = new ArrayBuffer(block_size);\r\n        this.view = new Float32Array(this.data);\r\n\r\n        for (const [index, uniform_index] of indices.entries()) {\r\n            const info: WebGLActiveInfo = gl.getActiveUniform(program, uniform_index)!;\r\n            let name = info.name;\r\n            const is_array = info.size > 1 && info.name.substr(-3) === \"[0]\";\r\n            if (is_array) name = name.substr(0, name.length - 3);\r\n            const byte_size =\r\n                (uniform_offsets[index + 1] ? uniform_offsets[index + 1] : block_size) - uniform_offsets[index];\r\n\r\n            this.map.set(\r\n                name,\r\n                new UniformBlock(this.data, info.type, uniform_offsets[index], info.size, byte_size / 4)\r\n            );\r\n        }\r\n\r\n        gl.bindBuffer(gl.UNIFORM_BUFFER, this.id);\r\n        gl.bufferData(gl.UNIFORM_BUFFER, block_size, gl.DYNAMIC_DRAW);\r\n    }\r\n\r\n    public bindShader(shader: Shader, binding: number): void {\r\n        const gl = shader.gl;\r\n        const block_index = gl.getUniformBlockIndex(shader.ID, this.name);\r\n        gl.uniformBlockBinding(shader.ID, block_index, binding);\r\n        gl.bindBufferBase(gl.UNIFORM_BUFFER, binding, this.id);\r\n    }\r\n\r\n    public update(gl: WebGL2RenderingContext): void {\r\n        gl.bindBuffer(gl.UNIFORM_BUFFER, this.id);\r\n        gl.bufferSubData(gl.UNIFORM_BUFFER, 0, this.view);\r\n    }\r\n\r\n    public set(uniform_name: string, data: TypedArray | number[] | number): void {\r\n        const uniform_block = this.map.get(uniform_name);\r\n        if (uniform_block) uniform_block.set(data);\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}