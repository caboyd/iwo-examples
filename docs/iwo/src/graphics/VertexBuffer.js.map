{"version":3,"file":"VertexBuffer.js","sources":["../../../../iwo/src/graphics/VertexBuffer.ts"],"sourcesContent":["import { WebGL } from \"./WebglHelper\";\r\nimport { ReferenceCounter } from \"helpers/ReferenceCounter\";\r\nimport { AttributeComponentCountMap, Attributes, BufferedGeometry } from \"geometry/BufferedGeometry\";\r\n\r\nexport class VertexBuffer {\r\n    public attributes: Attributes;\r\n    public buffers: WebGLBuffer[];\r\n    public VAO: WebGLVertexArrayObject | undefined;\r\n    public readonly references: ReferenceCounter;\r\n    public stride: number = 0;\r\n\r\n    public constructor(gl: WebGL2RenderingContext, geometry: BufferedGeometry) {\r\n        this.attributes = geometry.attributes;\r\n        this.references = new ReferenceCounter();\r\n        this.buffers = [];\r\n        this.constructFromBufferedGeometry(gl, geometry);\r\n    }\r\n\r\n    private constructFromBufferedGeometry(gl: WebGL2RenderingContext, geometry: BufferedGeometry): void {\r\n        this.VAO = gl.createVertexArray()!;\r\n        gl.bindVertexArray(this.VAO);\r\n\r\n        //Turn the geometry buffer into WebGLBuffers\r\n        for (const buffer of geometry.buffers) {\r\n            //Need to add buffer for index_buffer to not mess up indexing\r\n            if (buffer.target === gl.ELEMENT_ARRAY_BUFFER && geometry.index_buffer !== undefined){\r\n                this.buffers.push(gl.createBuffer()!);\r\n                continue;\r\n            }\r\n            const b = WebGL.buildBuffer(gl, buffer.target, buffer.buffer);\r\n            this.buffers.push(b);\r\n        }\r\n\r\n        this.setupVAOBuffers(gl);\r\n        gl.bindVertexArray(null);\r\n    }\r\n\r\n    public setupVAOBuffers(gl: WebGL2RenderingContext): void {\r\n        let bound_buffer = undefined;\r\n        for (const attrib of this.attributes) {\r\n            if (!attrib.enabled) continue;\r\n            //Bind correct buffer\r\n            if (this.buffers[attrib.buffer_index] !== bound_buffer) {\r\n                gl.bindBuffer(gl.ARRAY_BUFFER, this.buffers[attrib.buffer_index]);\r\n                bound_buffer = this.buffers[attrib.buffer_index];\r\n            }\r\n\r\n            gl.enableVertexAttribArray(attrib.type);\r\n            gl.vertexAttribPointer(\r\n                attrib.type,\r\n                AttributeComponentCountMap[attrib.type],\r\n                attrib.component_type,\r\n                attrib.normalized ?? false,\r\n                attrib.byte_stride ?? 0,\r\n                attrib.byte_offset ?? 0\r\n            );\r\n        }\r\n    }\r\n\r\n    public bindBuffers(gl: WebGL2RenderingContext): void {\r\n        gl.bindVertexArray(this.VAO!);\r\n    }\r\n\r\n    public destroy(gl: WebGL2RenderingContext): void {\r\n        if (this.references.count !== 0) {\r\n            console.warn(this);\r\n            console.warn(\"Can't destroy while still being referenced\");\r\n        } else {\r\n            if (this.VAO) gl.deleteVertexArray(this.VAO);\r\n            for (const buffer of this.buffers) gl.deleteBuffer(buffer);\r\n        }\r\n    }\r\n}\r\n"],"names":["ReferenceCounter"],"mappings":";;;;MAIa,YAAY;IAOrB,YAAmB,EAA0B,EAAE,QAA0B;QAFlE,WAAM,GAAW,CAAC,CAAC;QAGtB,IAAI,CAAC,UAAU,GAAG,QAAQ,CAAC,UAAU,CAAC;QACtC,IAAI,CAAC,UAAU,GAAG,IAAIA,kBAAgB,EAAE,CAAC;QACzC,IAAI,CAAC,OAAO,GAAG,EAAE,CAAC;QAClB,IAAI,CAAC,6BAA6B,CAAC,EAAE,EAAE,QAAQ,CAAC,CAAC;KACpD;IAEO,6BAA6B,CAAC,EAA0B,EAAE,QAA0B;QACxF,IAAI,CAAC,GAAG,GAAG,EAAE,CAAC,iBAAiB,EAAG,CAAC;QACnC,EAAE,CAAC,eAAe,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;;QAG7B,KAAK,MAAM,MAAM,IAAI,QAAQ,CAAC,OAAO,EAAE;;YAEnC,IAAI,MAAM,CAAC,MAAM,KAAK,EAAE,CAAC,oBAAoB,IAAI,QAAQ,CAAC,YAAY,KAAK,SAAS,EAAC;gBACjF,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE,CAAC,YAAY,EAAG,CAAC,CAAC;gBACtC,SAAS;aACZ;YACD,MAAM,CAAC,GAAG,KAAK,CAAC,WAAW,CAAC,EAAE,EAAE,MAAM,CAAC,MAAM,EAAE,MAAM,CAAC,MAAM,CAAC,CAAC;YAC9D,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;SACxB;QAED,IAAI,CAAC,eAAe,CAAC,EAAE,CAAC,CAAC;QACzB,EAAE,CAAC,eAAe,CAAC,IAAI,CAAC,CAAC;KAC5B;IAEM,eAAe,CAAC,EAA0B;QAC7C,IAAI,YAAY,GAAG,SAAS,CAAC;QAC7B,KAAK,MAAM,MAAM,IAAI,IAAI,CAAC,UAAU,EAAE;YAClC,IAAI,CAAC,MAAM,CAAC,OAAO;gBAAE,SAAS;;YAE9B,IAAI,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,YAAY,CAAC,KAAK,YAAY,EAAE;gBACpD,EAAE,CAAC,UAAU,CAAC,EAAE,CAAC,YAAY,EAAE,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,YAAY,CAAC,CAAC,CAAC;gBAClE,YAAY,GAAG,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,YAAY,CAAC,CAAC;aACpD;YAED,EAAE,CAAC,uBAAuB,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;YACxC,EAAE,CAAC,mBAAmB,CAClB,MAAM,CAAC,IAAI,EACX,0BAA0B,CAAC,MAAM,CAAC,IAAI,CAAC,EACvC,MAAM,CAAC,cAAc,EACrB,MAAM,CAAC,UAAU,IAAI,KAAK,EAC1B,MAAM,CAAC,WAAW,IAAI,CAAC,EACvB,MAAM,CAAC,WAAW,IAAI,CAAC,CAC1B,CAAC;SACL;KACJ;IAEM,WAAW,CAAC,EAA0B;QACzC,EAAE,CAAC,eAAe,CAAC,IAAI,CAAC,GAAI,CAAC,CAAC;KACjC;IAEM,OAAO,CAAC,EAA0B;QACrC,IAAI,IAAI,CAAC,UAAU,CAAC,KAAK,KAAK,CAAC,EAAE;YAC7B,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YACnB,OAAO,CAAC,IAAI,CAAC,4CAA4C,CAAC,CAAC;SAC9D;aAAM;YACH,IAAI,IAAI,CAAC,GAAG;gBAAE,EAAE,CAAC,iBAAiB,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;YAC7C,KAAK,MAAM,MAAM,IAAI,IAAI,CAAC,OAAO;gBAAE,EAAE,CAAC,YAAY,CAAC,MAAM,CAAC,CAAC;SAC9D;KACJ;;;;;"}